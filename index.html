
<!DOCTYPE html>
<html>
  <head>
    <!-- <script src="www.gstatic.com/firebasejs/9.6.5/firebase.js"></script> -->

    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <!----- KAYLA: ADDED COMPAT TO SRC URLS: 
    SOURCE: https://stackoverflow.com/questions/69140697/unexpected-token-export-firebase-app-js1590  -->
    <script src="https://www.gstatic.com/firebasejs/9.6.5/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.5/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.5/firebase-database-compat.js"></script>
  <script> 

/**
 * Firebase config block.
 */
var config = {
  apiKey: "AIzaSyBKSXFT6PGoaJTTb-TqyT2SCFFR-Zcea38",
  authDomain: "pea922.firebaseapp.com",
  databaseURL: "https://pea922-default-rtdb.firebaseio.com/",
  projectId: "pea922",
  storageBucket: "pea922.appspot.com",
  messagingSenderId: "888111191717",
  appId: "1:888111191717:web:5866818bc5cfdaacdd1f4c",
  measurementId: "G-S02HT6LTGT",
};

firebase.initializeApp(config); 



/**
 * Data object to be written to Firebase.
 */

var data = {sender: null, timestamp: null, lat: null, lng: null};

function makeInfoBox(controlDiv, map) {
  // Set CSS for the control border.
  var controlUI = document.createElement('div');
  controlUI.style.boxShadow = 'rgba(0, 0, 0, 0.298039) 0px 1px 4px -1px';
  controlUI.style.backgroundColor = '#fff';
  controlUI.style.border = '2px solid #fff';
  controlUI.style.borderRadius = '2px';
  controlUI.style.marginBottom = '22px';
  controlUI.style.marginTop = '10px';
  controlUI.style.textAlign = 'center';
  controlDiv.appendChild(controlUI);

  // Set CSS for the control interior.
  var controlText = document.createElement('div');
  controlText.style.color = 'rgb(25,25,25)';
  controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
  controlText.style.fontSize = '100%';
  controlText.style.padding = '6px';
  controlText.textContent =
      'The map shows all clicks made in the last 10 minutes.';
  controlUI.appendChild(controlText);
}



      /**
       * Creates a map object with a click listener and a heatmap.
       */
  function initMap() {
    console.log ("inside of init Map")
    
    //RENDER MAP
    const map = new google.maps.Map(document.getElementById("map"), {
      zoom: 11,
      center: {lat: 47.60621, lng: -122.332071},
    });
    
    // SET MARKER AS CUSTOM IMAGE
    
    // // HARDCODED DATA BELOW
    // new google.maps.Marker({
    //   icon: image,
    //   position: {lat: 47.60621, lng: -122.332071},
    //   map,
    // });

    
    
    // LISTENS FOR THE CLICK AND ADDS THEM TO THE MAP
    map.addListener('click', function(e) {
      data.lat = e.latLng.lat();
      data.lng = e.latLng.lng();
      addToFirebase(data);
    });
    const image = {
            url:"https://upload.wikimedia.org/wikipedia/commons/e/e7/Fist_.svg",
            scaledSize: new google.maps.Size(30, 30), // scaled size
            origin: new google.maps.Point(0,0), // origin
            anchor: new google.maps.Point(0, 0), // anchor
        };
    var point = new google.maps.Marker({
              icon: image,
              map: map,
              position: {
                lat: data.lat,
                lng: data.lng,
            } 
          });

   initFirebase.bind(undefined, map); 
  }

  initFirebase()


  

  function initFirebase(map) {
    console.log ("inside of init firebase")

// Reference to the clicks in Firebase.
        var startTime = new Date().getTime()
        var clicks = firebase.database().ref('clicks');
        
    
    // Listen for clicks and add them to the map.
        clicks.orderByChild('timestamp').startAt(startTime).on('child_added',
          function(snapshot) {
          
        // Get that click from firebase.
            var data = snapshot.val();
                console.log(data);
                var point = (data.lat, data.lng)
                console.log(point)
                
            map.getData().push(point);
            console.log ("does mat.getData work?")
        // Add the point to the map.
  
        });
      }  
      function getTimestamp(addClick) {
        console.log ("inside of get timestamp")
        // Reference to location for saving the last click time.
        var ref = firebase.database().ref('last_message/' + data.sender);

        ref.onDisconnect().remove();  // Delete reference from firebase on disconnect.

        // Set value to timestamp.
        ref.set(firebase.database.ServerValue.TIMESTAMP, function(err) {
          if (err) {  // Write to last message was unsuccessful.
            console.log(err);
          } else {  // Write to last message was successful.
            ref.once('value', function(snap) {
              addClick(snap.val());  // Add click with same timestamp.
            }, function(err) {
              console.warn(err);
            });
          }
        });
      }    

  function addToFirebase(data) {
        console.log ("inside of add to firebase")
        getTimestamp(function(timestamp) {
          // Add the new timestamp to the record data.
          data.timestamp = timestamp;
          var ref = firebase.database().ref('clicks').push(data, function(err) {
            if (err) {  // Data was not written to firebase.
              console.warn(err);
            }
          });
        });
  }    
  </script>
    <script defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCiIWgSVB4VfUOPdHNGcYt8Tw767VmHcBg&libraries=visualization&callback=initMap">
    </script>
  </body>
</html>
